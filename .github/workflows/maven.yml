name: ThingsBoard CI (Maven JDK17 + Gradle JDK11 + Docker TAR)

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Install JDK 11 (for Gradle in packaging/js)
      - name: Set up JDK 11 (Gradle)
        id: jdk11
        uses: actions/setup-java@v4
        with:
          java-version: "11"
          distribution: "temurin"

      - name: Capture JDK 11 path
        run: |
          echo "JDK11_HOME=$JAVA_HOME" >> $GITHUB_ENV
          echo "JDK11_HOME=$JAVA_HOME"

      # Install JDK 17 (for Maven build)
      - name: Set up JDK 17 (Maven)
        id: jdk17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: maven

      - name: Capture JDK 17 path
        run: |
          echo "JDK17_HOME=$JAVA_HOME" >> $GITHUB_ENV
          echo "JDK17_HOME=$JAVA_HOME"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Show versions
        run: |
          echo "JDK11_HOME=$JDK11_HOME"
          echo "JDK17_HOME=$JDK17_HOME"
          "$JDK11_HOME/bin/java" -version
          "$JDK17_HOME/bin/java" -version
          mvn -version
          docker version

      # Force Gradle inside packaging/js to use JDK 11 (fix for major version 61)
      - name: Configure Gradle Java home for packaging/js
        run: |
          mkdir -p packaging/js
          cat > packaging/js/gradle.properties <<EOF
          org.gradle.java.home=${JDK11_HOME}
          EOF
          echo "Created packaging/js/gradle.properties:"
          cat packaging/js/gradle.properties

      # Build ThingsBoard (skip license check to avoid your earlier failure)
      - name: Build ThingsBoard (skip tests, skip license check) using JDK 17
        env:
          JAVA_HOME: ${{ env.JDK17_HOME }}
          PATH: ${{ env.JDK17_HOME }}/bin:${{ env.PATH }}
        run: |
          java -version
          mvn -B -T 0.8C clean install \
            -DskipTests \
            -Dlicense.skip=true

      # Build Docker images
      - name: Build ThingsBoard Docker images (skip license check) using JDK 17
        env:
          JAVA_HOME: ${{ env.JDK17_HOME }}
          PATH: ${{ env.JDK17_HOME }}/bin:${{ env.PATH }}
        run: |
          mvn -B -T 0.8C clean install \
            -DskipTests \
            -Ddockerfile.skip=false \
            -Dlicense.skip=true

      - name: List Docker images
        run: |
          docker images | head -n 200

      - name: Save ThingsBoard images (thingsboard/*) to TAR
        run: |
          set -euo pipefail
          mkdir -p out

          mapfile -t IMAGES < <(docker images --format "{{.Repository}}:{{.Tag}}" | grep -E '^thingsboard/' || true)

          if [ "${#IMAGES[@]}" -eq 0 ]; then
            echo "No images matching 'thingsboard/*' found. Available images:"
            docker images
            exit 1
          fi

          echo "Saving images:"
          printf '%s\n' "${IMAGES[@]}"

          docker save "${IMAGES[@]}" -o out/thingsboard-images.tar

      - name: Upload ThingsBoard image TAR
        uses: actions/upload-artifact@v4
        with:
          name: thingsboard-images-tar
          path: out/thingsboard-images.tar
          retention-days: 7

      # Optional: PostgreSQL image TAR
      - name: Pull PostgreSQL image
        run: docker pull postgres:16

      - name: Save PostgreSQL image to TAR
        run: |
          mkdir -p out
          docker save postgres:16 -o out/postgres-16.tar

      - name: Upload PostgreSQL image TAR
        uses: actions/upload-artifact@v4
        with:
          name: postgres-16-tar
          path: out/postgres-16.tar
          retention-days: 7
