name: Build ThingsBoard + Docker TARs (PostgreSQL)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ---------- Java 11 for Gradle (JS build) ----------
      - name: Set up JDK 11 (for Gradle/JS)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "11"

      - name: Configure Gradle to use JDK 11
        shell: bash
        run: |
          cat > gradle.properties <<'EOF'
          org.gradle.java.home=${JAVA_HOME}
          EOF
          echo "JAVA_HOME for Gradle is: $JAVA_HOME"
          test -f gradle.properties && cat gradle.properties

      # ---------- Java 17 for Maven (server build) ----------
      - name: Set up JDK 17 (for Maven)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      # Maven is NOT guaranteed to be installed => install it explicitly
      - name: Install Maven
        shell: bash
        run: |
          sudo apt-get update
          sudo apt-get install -y maven
          which mvn
          mvn -version
          java -version

      # ---------- Build ThingsBoard ----------
      # Note: -Dlicense.skip=true avoids the license check failure you hit earlier
      - name: Build ThingsBoard (Maven)
        shell: bash
        run: |
          mvn -B -T 0.8C clean install -DskipTests -Dlicense.skip=true

      # ---------- Build Docker images and export as TAR ----------
      # Adjust paths/targets if your ThingsBoard fork differs.
      - name: Build Docker images (PostgreSQL)
        shell: bash
        run: |
          # Common ThingsBoard docker build location is "docker/" in repo root
          # This builds the PostgreSQL images (typically tb-postgres and tb-node)
          cd docker
          chmod +x *.sh || true

          # Try the standard build script naming used by ThingsBoard
          if [ -f "./build.sh" ]; then
            ./build.sh postgresql
          elif [ -f "./docker-build.sh" ]; then
            ./docker-build.sh postgresql
          else
            echo "No known docker build script found in ./docker"
            ls -la
            exit 1
          fi

      - name: Save Docker images to TAR
        shell: bash
        run: |
          mkdir -p artifacts

          # These are the most common image names; adapt if your build tags differ.
          # We'll save any matching thingsboard/tb-* images to be safe.
          docker images

          IMAGES=$(docker images --format '{{.Repository}}:{{.Tag}}' | grep -E '(^thingsboard/|/tb-)' || true)
          if [ -z "$IMAGES" ]; then
            echo "No ThingsBoard images found to save. Check docker build output / tags."
            exit 1
          fi

          echo "$IMAGES" | while read -r img; do
            safe_name=$(echo "$img" | tr '/:' '__')
            echo "Saving $img -> artifacts/${safe_name}.tar"
            docker save -o "artifacts/${safe_name}.tar" "$img"
          done

          ls -lh artifacts

      - name: Upload Docker TAR artifacts
        uses: actions/upload-artifact@v4
        with:
          name: thingsboard-docker-tars
          path: artifacts/*.tar
          if-no-files-found: error
