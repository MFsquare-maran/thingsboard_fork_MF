name: ThingsBoard CI (Maven + Docker TAR)

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: maven

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Show versions
        run: |
          java -version
          mvn -version
          docker version

      # Build ThingsBoard from source (skip failing license check)
      - name: Build ThingsBoard (skip tests, skip license check)
        run: |
          mvn -B -T 0.8C clean install \
            -DskipTests \
            -Dlicense.skip=true

      # Build docker images as in ThingsBoard docs
      - name: Build ThingsBoard Docker images (skip license check)
        run: |
          mvn -B -T 0.8C clean install \
            -DskipTests \
            -Ddockerfile.skip=false \
            -Dlicense.skip=true

      - name: List Docker images
        run: |
          docker images | head -n 200

      # Save all locally built thingsboard/* images to tar (robust against changing tags)
      - name: Save ThingsBoard images to TAR
        run: |
          set -euo pipefail
          mkdir -p out

          # Collect all images whose repository starts with "thingsboard/"
          mapfile -t IMAGES < <(docker images --format "{{.Repository}}:{{.Tag}}" | grep -E '^thingsboard/' || true)

          if [ "${#IMAGES[@]}" -eq 0 ]; then
            echo "No images matching 'thingsboard/*' found. Available images:"
            docker images
            exit 1
          fi

          echo "Saving images:"
          printf '%s\n' "${IMAGES[@]}"

          docker save "${IMAGES[@]}" -o out/thingsboard-images.tar

      - name: Upload ThingsBoard image TAR
        uses: actions/upload-artifact@v4
        with:
          name: thingsboard-images-tar
          path: out/thingsboard-images.tar
          retention-days: 7

      # Optional: also export PostgreSQL image as TAR (official image)
      - name: Pull PostgreSQL image
        run: |
          docker pull postgres:16

      - name: Save PostgreSQL image to TAR
        run: |
          mkdir -p out
          docker save postgres:16 -o out/postgres-16.tar

      - name: Upload PostgreSQL image TAR
        uses: actions/upload-artifact@v4
        with:
          name: postgres-16-tar
          path: out/postgres-16.tar
          retention-days: 7
